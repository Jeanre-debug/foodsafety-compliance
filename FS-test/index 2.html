<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Safety Manager</title>
    
                <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-storage-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-content h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-content p {
            color: #666;
            font-size: 1.1rem;
        }

        .firebase-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .firebase-config {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e1e8ed;
        }

        .config-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 1000;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 1);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .photo-upload {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-upload:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .photo-upload.dragover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-left: 20px;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 30px;
            width: 15px;
            height: 15px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .timeline-date {
            font-size: 0.9rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .timeline-category {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .category-food-safety { background: #ff6b6b20; color: #ff6b6b; }
        .category-health-safety { background: #4ecdc420; color: #4ecdc4; }
        .category-cleaning { background: #45b74920; color: #45b749; }
        .category-training { background: #f7931e20; color: #f7931e; }
        .category-equipment { background: #9b59b620; color: #9b59b6; }

        .timeline-content {
            margin-bottom: 15px;
        }

        .timeline-photos {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .timeline-photo {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .timeline-photo:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 15px;
        }

        .export-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            margin-left: 10px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.5);
        }

        .export-btn:hover div {
            left: 0;
        }

        /* Enhanced button animations */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            margin-bottom: 25px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Authentication Styles */
        .auth-container {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 50px auto;
        }

        .auth-container.active {
            display: block;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-details {
            flex: 1;
        }

        .user-email {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-status {
            font-size: 0.9rem;
            color: #28a745;
        }

        .signout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .signout-btn:hover {
            background: #c82333;
        }

        .auth-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .auth-success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        /* Staff Selector Styles */
        .staff-selector-container {
            position: relative;
        }

        .staff-input-wrapper {
            position: relative;
        }

        .staff-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .staff-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.2s ease;
        }

        .staff-dropdown-item:hover {
            background: #f8f9fa;
        }

        .staff-dropdown-item.selected {
            background: #667eea;
            color: white;
        }

        .selected-staff-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .staff-tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .staff-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .staff-tag-remove {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .staff-tag-remove:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .staff-list-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .staff-list-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .staff-list-item .staff-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .staff-list-item .remove-staff-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .staff-list-item .remove-staff-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .timeline-item {
                margin-left: 10px;
            }

            .auth-container {
                margin: 20px auto;
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container active">
        <div class="auth-header">
            <h2>🛡️ Food Safety Manager</h2>
            <p>Sign in to sync your data across devices</p>
        </div>
        
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="showAuthTab('signin')">Sign In</button>
            <button class="auth-tab" onclick="showAuthTab('signup')">Create Account</button>
        </div>
        
        <!-- Sign In Form -->
        <form id="signin-form" class="auth-form active">
            <div id="signin-error" class="auth-error" style="display: none;"></div>
            <div class="form-group">
                <label for="signin-email">Email</label>
                <input type="email" id="signin-email" required>
            </div>
            <div class="form-group">
                <label for="signin-password">Password</label>
                <input type="password" id="signin-password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Sign In</button>
        </form>
        
        <!-- Sign Up Form -->
        <form id="signup-form" class="auth-form">
            <div id="signup-error" class="auth-error" style="display: none;"></div>
            <div id="signup-success" class="auth-success" style="display: none;"></div>
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" required>
            </div>
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" required minlength="6">
            </div>
            <div class="form-group">
                <label for="signup-confirm-password">Confirm Password</label>
                <input type="password" id="signup-confirm-password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Create Account</button>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <div class="header-content">
                <h1>🛡️ Food Safety Manager</h1>
                <p>Document incidents, track compliance, and maintain professional records</p>
            </div>
            <div class="firebase-status">
                <div class="status-indicator" id="firebase-indicator"></div>
                <span id="firebase-status-text">Not connected</span>
            </div>
        </div>

        <!-- User Info Display -->
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-details">
                <div class="user-email" id="user-email">user@example.com</div>
                <div class="user-status" id="user-status">Signed in</div>
            </div>
            <button class="signout-btn" onclick="signOut()">Sign Out</button>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('dashboard')">📊 Dashboard</button>
            <button class="nav-btn" onclick="showSection('add-record')">➕ Add Record</button>
            <button class="nav-btn" onclick="showSection('timeline')">📋 Timeline</button>
            <button class="nav-btn" onclick="showSection('staff-warnings')">🚨 Staff Warnings</button>
            <button class="nav-btn" onclick="showSection('settings')">⚙️ Settings</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">📊 Dashboard Overview</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-records">0</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="this-month">0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="high-priority">0</div>
                    <div class="stat-label">High Priority</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="with-photos">0</div>
                    <div class="stat-label">With Photos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="staff-warnings-count">0</div>
                    <div class="stat-label">Staff Warnings</div>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; color: #2c3e50;">Recent Activity</h3>
            <div id="recent-activity"></div>
            
            <h3 style="margin-bottom: 20px; color: #2c3e50; margin-top: 40px;">🚨 Staff Warning System</h3>
            <div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    This system tracks staff members involved in incidents. Warnings persist even when records are deleted to maintain accountability.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #28a745;">📝</span>
                        <span style="font-size: 0.9rem;">Low (2-3 incidents)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #ffc107;">⚡</span>
                        <span style="font-size: 0.9rem;">Medium (4-6 incidents)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #fd7e14;">⚠️</span>
                        <span style="font-size: 0.9rem;">High (7-9 incidents)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #dc3545;">🚨</span>
                        <span style="font-size: 0.9rem;">Critical (10+ incidents)</span>
                    </div>
                </div>
            </div>
            <div id="dashboard-staff-warnings-container"></div>
        </div>

        <!-- Add Record Section -->
        <div id="add-record" class="section">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">➕ Add New Record</h2>
            
            <form id="record-form">
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="food-safety">🍽️ Food Safety Violation</option>
                        <option value="health-safety">⚕️ Health & Safety Issue</option>
                        <option value="cleaning">🧽 Cleaning Standards</option>
                        <option value="training">📚 Training Required</option>
                        <option value="equipment">🔧 Equipment Issue</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="priority">Priority Level</label>
                    <select id="priority" required>
                        <option value="">Select Priority</option>
                        <option value="low">🟢 Low - Minor issue</option>
                        <option value="medium">🟡 Medium - Needs attention</option>
                        <option value="high">🔴 High - Immediate action required</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="staff-member">Staff Member(s) Involved</label>
                    <div class="staff-selector-container">
                        <div class="staff-input-wrapper">
                            <input type="text" id="staff-member-input" placeholder="Start typing to search staff members..." autocomplete="off">
                            <div id="staff-dropdown" class="staff-dropdown" style="display: none;"></div>
                        </div>
                        <div id="selected-staff-tags" class="selected-staff-tags"></div>
                        <input type="hidden" id="staff-member" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="Kitchen, Prep Area, Storage, etc." required>
                </div>

                <div class="form-group">
                    <label for="description">Description & Comments</label>
                    <textarea id="description" placeholder="Detailed description of the issue, actions taken, and follow-up required..." required></textarea>
                </div>

                <div class="form-group">
                    <label>Upload Photos (Optional)</label>
                    <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
                        <p>📸 Click to upload photos or drag & drop</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">Supports: JPG, PNG, WebP, DNG (Raw)</p>
                        <input type="file" id="photo-input" multiple accept="image/*,.dng" style="display: none;">
                    </div>
                    <div id="photo-preview" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px;">
                    <button type="submit" class="btn">💾 Save Record</button>
                    <button type="button" class="btn export-btn" onclick="exportData()">📄 Export All Data</button>
                </div>
            </form>
        </div>

        <!-- Edit Record Section -->
        <div id="edit-record" class="section">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">✏️ Edit Record</h2>
            
            <form id="edit-record-form">
                <div class="form-group">
                    <label for="edit-category">Category</label>
                    <select id="edit-category" required>
                        <option value="">Select Category</option>
                        <option value="food-safety">🍽️ Food Safety Violation</option>
                        <option value="health-safety">⚕️ Health & Safety Issue</option>
                        <option value="cleaning">🧽 Cleaning Standards</option>
                        <option value="training">📚 Training Required</option>
                        <option value="equipment">🔧 Equipment Issue</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-priority">Priority Level</label>
                    <select id="edit-priority" required>
                        <option value="">Select Priority</option>
                        <option value="low">🟢 Low - Minor issue</option>
                        <option value="medium">🟡 Medium - Needs attention</option>
                        <option value="high">🔴 High - Immediate action required</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-staff-member">Staff Member(s) Involved</label>
                    <div class="staff-selector-container">
                        <div class="staff-input-wrapper">
                            <input type="text" id="edit-staff-member-input" placeholder="Start typing to search staff members..." autocomplete="off">
                            <div id="edit-staff-dropdown" class="staff-dropdown" style="display: none;"></div>
                        </div>
                        <div id="edit-selected-staff-tags" class="selected-staff-tags"></div>
                        <input type="hidden" id="edit-staff-member" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-location">Location</label>
                    <input type="text" id="edit-location" placeholder="Kitchen, Prep Area, Storage, etc." required>
                </div>

                <div class="form-group">
                    <label for="edit-description">Description & Comments</label>
                    <textarea id="edit-description" placeholder="Detailed description of the issue, actions taken, and follow-up required..." required></textarea>
                </div>

                <div class="form-group">
                    <label>Upload Photos (Optional)</label>
                    <div class="photo-upload" onclick="document.getElementById('edit-photo-input').click()">
                        <p>📸 Click to upload photos or drag & drop</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">Supports: JPG, PNG, WebP, DNG (Raw)</p>
                        <input type="file" id="edit-photo-input" multiple accept="image/*,.dng" style="display: none;">
                    </div>
                    <div id="edit-photo-preview" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px;">
                    <button type="submit" class="btn" style="background: linear-gradient(45deg, #17a2b8, #138496);">💾 Update Record</button>
                    <button type="button" class="btn" onclick="cancelEdit()" style="background: linear-gradient(45deg, #6c757d, #495057);">❌ Cancel</button>
                </div>
            </form>
        </div>

        <!-- Timeline Section -->
        <div id="timeline" class="section">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">📋 Compliance Timeline</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" class="search-box" id="search-input" placeholder="Search records by staff, location, category, or description..." style="flex: 1; min-width: 300px;">
                <button type="button" class="btn" onclick="exportToPDF()" style="background: linear-gradient(45deg, #28a745, #20c997); box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4); font-size: 1.1rem; padding: 18px 35px; border-radius: 15px; position: relative; overflow: hidden;">
                    <span style="position: relative; z-index: 2;">Generate Professional Report</span>
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(45deg, #20c997, #28a745); transition: left 0.3s ease;"></div>
                </button>
                <button type="button" class="btn" onclick="toggleMassDelete()" style="background: linear-gradient(45deg, #dc3545, #c82333);">Mass Delete</button>
            </div>
            
            <div class="timeline" id="timeline-container">
                <p style="text-align: center; color: #666; padding: 40px;">No records found. Start by adding your first compliance record.</p>
            </div>
        </div>

        <!-- Staff Warnings Section -->
        <div id="staff-warnings" class="section">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">🚨 Staff Warning System</h2>
            
            <div style="background: rgba(255, 255, 255, 0.9); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">About the Warning System</h3>
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                    This system automatically tracks staff members involved in incidents. Warning counts are <strong>cumulative and never decrease</strong> when records are deleted, ensuring accountability and pattern tracking. Counts only reset when manually cleared.
                </p>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(40, 167, 69, 0.1); border-radius: 10px; border: 1px solid rgba(40, 167, 69, 0.3);">
                        <span style="color: #28a745; font-size: 1.2rem;">📝</span>
                        <div>
                            <div style="font-weight: bold; color: #28a745;">Low</div>
                            <div style="font-size: 0.8rem; color: #666;">2-3 incidents</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(255, 193, 7, 0.1); border-radius: 10px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        <span style="color: #ffc107; font-size: 1.2rem;">⚡</span>
                        <div>
                            <div style="font-weight: bold; color: #ffc107;">Medium</div>
                            <div style="font-size: 0.8rem; color: #666;">4-6 incidents</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(253, 126, 20, 0.1); border-radius: 10px; border: 1px solid rgba(253, 126, 20, 0.3);">
                        <span style="color: #fd7e14; font-size: 1.2rem;">⚠️</span>
                        <div>
                            <div style="font-weight: bold; color: #fd7e14;">High</div>
                            <div style="font-size: 0.8rem; color: #666;">7-9 incidents</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(220, 53, 69, 0.1); border-radius: 10px; border: 1px solid rgba(220, 53, 69, 0.3);">
                        <span style="color: #dc3545; font-size: 1.2rem;">🚨</span>
                        <div>
                            <div style="font-weight: bold; color: #dc3545;">Critical</div>
                            <div style="font-size: 0.8rem; color: #666;">10+ incidents</div>
                        </div>
                    </div>
                </div>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 10px; color: #856404;">
                    <strong>💡 Tip:</strong> Staff with high incident counts may benefit from additional training or supervision. Consider reviewing their training records and providing targeted support.
                </div>
            </div>

            <!-- Button Information Section -->
            <div style="background: rgba(255, 255, 255, 0.9); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">🛠️ Management Tools</h3>
                <p style="color: #666; margin-bottom: 20px;">Use these tools to manage and maintain your staff warning system:</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div style="background: rgba(40, 167, 69, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 8px;">📊 Initialize from Existing Records</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Scans all your existing safety records and builds the warning system from historical data. Use this when you first set up the system or want to rebuild it from scratch.</p>
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 8px; border-radius: 6px; font-size: 0.8rem; color: #28a745;">
                            <strong>When to use:</strong> First-time setup, rebuilding system, or after major data changes
                        </div>
                    </div>
                    
                    <div style="background: rgba(23, 162, 184, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                        <h4 style="color: #17a2b8; margin-bottom: 8px;">🧹 Clean Up Staff Warnings</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Fixes issues with comma-separated names by splitting them into individual staff members. Redistributes incident counts correctly.</p>
                        <div style="background: rgba(23, 162, 184, 0.1); padding: 8px; border-radius: 6px; font-size: 0.8rem; color: #17a2b8;">
                            <strong>When to use:</strong> If you see combined names like "John, Sarah" instead of separate entries
                        </div>
                    </div>
                    
                    <div style="background: rgba(253, 126, 20, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #fd7e14;">
                        <h4 style="color: #fd7e14; margin-bottom: 8px;">🔄 Refresh Warning Levels</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Recalculates all warning levels based on current incident counts. Ensures accuracy and fixes any inconsistencies.</p>
                        <div style="background: rgba(253, 126, 20, 0.1); padding: 8px; border-radius: 6px; font-size: 0.8rem; color: #fd7e14;">
                            <strong>When to use:</strong> If warning levels seem incorrect, or after manual data changes
                        </div>
                    </div>
                    
                    <div style="background: rgba(111, 66, 193, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #6f42c1;">
                        <h4 style="color: #6f42c1; margin-bottom: 8px;">🔍 Test Warning System</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Runs diagnostic tests to check if the warning system is working correctly. Shows detailed information in the browser console.</p>
                        <div style="background: rgba(111, 66, 193, 0.1); padding: 8px; border-radius: 6px; font-size: 0.8rem; color: #6f42c1;">
                            <strong>When to use:</strong> Troubleshooting issues, verifying calculations, or checking system health
                        </div>
                    </div>
                    
                    <div style="background: rgba(108, 117, 125, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #6c757d;">
                        <h4 style="color: #6c757d; margin-bottom: 8px;">🔄 Reset All Staff Warnings</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">Completely clears all staff warning data. This action is irreversible and will remove all incident tracking history.</p>
                        <div style="background: rgba(108, 117, 125, 0.1); padding: 8px; border-radius: 6px; font-size: 0.8rem; color: #6c757d;">
                            <strong>When to use:</strong> Starting fresh, clearing old data, or resetting for new period
                        </div>
                    </div>
                </div>
                
                <div style="background: #e8f4fd; border: 1px solid #bee5eb; padding: 15px; border-radius: 10px; color: #0c5460;">
                    <strong>ℹ️ Quick Reference:</strong> 
                    <ul style="margin: 10px 0 0 20px; color: #0c5460;">
                        <li><strong>New setup:</strong> Use "Initialize from Existing Records" first</li>
                        <li><strong>Name issues:</strong> Use "Clean Up Staff Warnings"</li>
                        <li><strong>Wrong levels:</strong> Use "Refresh Warning Levels"</li>
                        <li><strong>Problems:</strong> Use "Test Warning System" to diagnose</li>
                        <li><strong>Fresh start:</strong> Use "Reset All Staff Warnings" (⚠️ permanent)</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-bottom: 30px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button type="button" class="btn" onclick="initializeStaffWarningsFromRecords()" style="background: linear-gradient(45deg, #28a745, #20c997);">
                    📊 Initialize from Existing Records
                </button>
                <button type="button" class="btn" onclick="cleanupStaffWarnings()" style="background: linear-gradient(45deg, #17a2b8, #138496);">
                    🧹 Clean Up Staff Warnings
                </button>
                <button type="button" class="btn" onclick="refreshWarningLevels()" style="background: linear-gradient(45deg, #fd7e14, #e55a00);">
                    🔄 Refresh Warning Levels
                </button>
                <button type="button" class="btn" onclick="testWarningSystem()" style="background: linear-gradient(45deg, #6f42c1, #5a32a3);">
                    🔍 Test Warning System
                </button>
                <button type="button" class="btn" onclick="resetStaffWarnings()" style="background: linear-gradient(45deg, #6c757d, #495057);">
                    🔄 Reset All Staff Warnings
                </button>
            </div>
            
            <div id="staff-warnings-container"></div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">⚙️ Settings</h2>
            
            <!-- Staff Management Section -->
            <div class="firebase-config" style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">👥 Staff Management</h3>
                <p style="color: #666; margin-bottom: 20px;">Manage your staff members for easier record creation and consistent tracking.</p>
                
                <!-- Add New Staff -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" id="new-staff-name" placeholder="Enter staff member name" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 0.9rem;">
                    <button type="button" class="btn" onclick="addStaffMember()" style="background: linear-gradient(45deg, #28a745, #20c997); padding: 12px 20px;">
                        ➕ Add Staff
                    </button>
                </div>
                
                <!-- Staff List -->
                <div id="staff-list-container" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Current Staff Members</h4>
                    <div id="staff-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        <!-- Staff members will be populated here -->
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn" onclick="importDefaultStaff()" style="background: linear-gradient(45deg, #17a2b8, #138496);">
                        📋 Import Sample Staff
                    </button>
                    <button type="button" class="btn" onclick="clearAllStaff()" style="background: linear-gradient(45deg, #6c757d, #495057);">
                        🗑️ Clear All Staff
                    </button>
                </div>
            </div>
            
            <div class="firebase-config">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">Account Information</h3>
                <div id="account-info" style="margin-bottom: 20px;">
                    <p style="color: #666;">You are signed in with a secure account. Your data is automatically synced across all your devices.</p>
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="settings-email" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-group">
                    <label>Account Status</label>
                    <input type="text" id="settings-status" readonly style="background: #f8f9fa;" value="Active">
                </div>
                
                <div class="form-group">
                    <label>Data Sync Status</label>
                    <input type="text" id="settings-sync" readonly style="background: #f8f9fa;" value="Automatic">
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                    <button type="button" class="btn" onclick="exportData()">📄 Export All Data</button>
                    <button type="button" class="btn" onclick="signOut()" style="background: #dc3545;">🚪 Sign Out</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; color: #155724; border: 1px solid #c3e6cb;">
                    <strong>✅ Connected to Cloud:</strong> Your data is automatically backed up and synced across devices.
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for photo viewing -->
    <div id="photo-modal" class="modal" onclick="closeModal()">
        <div class="modal-content">
            <img id="modal-image" src="" alt="Full size photo">
        </div>
    </div>

    <!-- Sync notification -->
    <div id="sync-notification" class="sync-status" style="display: none;">
        <span id="sync-message"></span>
    </div>

    <script>
        // Firebase configuration
        let firebaseApp = null;
        let db = null;
        let storage = null;
        let auth = null;
        let isFirebaseInitialized = false;
        let currentUser = null;

        // Data storage - now user-specific
        let records = [];
        let selectedPhotos = [];
        let editPhotos = []; // Track photos for edit form
        let staffWarnings = {}; // Track staff warnings and incident counts
        let staffMembers = []; // Track staff members for dropdown
        let selectedStaffMembers = []; // Track selected staff for current record
        let editSelectedStaffMembers = []; // Track selected staff for edit form
        let editingRecordId = null; // Track which record is being edited

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Configure Firebase first
            const yourFirebaseConfig = {
                apiKey: "AIzaSyDCWQaDydeC0oK4mi2LMXHlUWIszG_ywTE",
                authDomain: "foodsafety-76427.firebaseapp.com",
                projectId: "foodsafety-76427",
                storageBucket: "foodsafety-76427.firebasestorage.app",
                messagingSenderId: "175877285149",
                appId: "1:175877285149:web:c0461ba373250865cdedf4"
            };
            
            // Initialize Firebase
            initializeFirebase(yourFirebaseConfig);
            
            // Setup authentication listeners
            setupAuthListeners();
            
            // Setup form handlers
            setupAuthForms();
        });



        function initializeFirebase(config) {
            try {
                if (firebaseApp) {
                    firebaseApp.delete();
                }

                firebaseApp = firebase.initializeApp(config);
                db = firebase.firestore();
                storage = firebase.storage();
                auth = firebase.auth();
                
                isFirebaseInitialized = true;
                updateFirebaseStatus(true, 'Connected to Firebase');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateFirebaseStatus(false, 'Connection failed');
            }
        }

        // Authentication Functions
        function setupAuthListeners() {
            if (!auth) return;
            
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    showApp();
                    loadUserData();
                    updateUserInfo(user);
                } else {
                    // User is signed out
                    currentUser = null;
                    records = [];
                    showAuth();
                    updateUserInfo(null);
                }
            });
        }

        function setupAuthForms() {
            // Sign In Form
            document.getElementById('signin-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                signIn(email, password);
            });

            // Sign Up Form
            document.getElementById('signup-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                if (password !== confirmPassword) {
                    showAuthError('signup', 'Passwords do not match');
                    return;
                }
                
                signUp(email, password);
            });
        }

        function showAuthTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update forms
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            if (tab === 'signin') {
                document.getElementById('signin-form').classList.add('active');
            } else {
                document.getElementById('signup-form').classList.add('active');
            }
            
            // Clear errors
            hideAuthErrors();
        }

        function signIn(email, password) {
            hideAuthErrors();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('Signed in successfully');
                })
                .catch((error) => {
                    console.error('Sign in error:', error);
                    let errorMessage = 'Sign in failed';
                    
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'No account found with this email';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Incorrect password';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email address';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Account has been disabled';
                            break;
                    }
                    
                    showAuthError('signin', errorMessage);
                });
        }

        function signUp(email, password) {
            hideAuthErrors();
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('Account created successfully');
                    showAuthSuccess('Account created successfully! You can now sign in.');
                    
                    // Clear form
                    document.getElementById('signup-form').reset();
                    
                    // Switch to sign in tab
                    setTimeout(() => {
                        showAuthTab('signin');
                    }, 2000);
                })
                .catch((error) => {
                    console.error('Sign up error:', error);
                    let errorMessage = 'Account creation failed';
                    
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'An account with this email already exists';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email address';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password should be at least 6 characters';
                            break;
                    }
                    
                    showAuthError('signup', errorMessage);
                });
        }

        function signOut() {
            auth.signOut()
                .then(() => {
                    console.log('Signed out successfully');
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                });
        }

        function showAuth() {
            document.getElementById('auth-container').classList.add('active');
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('auth-container').classList.remove('active');
            document.getElementById('app-container').style.display = 'block';
            
            // Initialize app components
            updateDashboard();
            updateTimeline();
            updateStaffWarnings();
            setupPhotoUpload();
            setupSearch();
        }

        function updateUserInfo(user) {
            const avatar = document.getElementById('user-avatar');
            const email = document.getElementById('user-email');
            const status = document.getElementById('user-status');
            const settingsEmail = document.getElementById('settings-email');
            
            if (user) {
                const initial = user.email.charAt(0).toUpperCase();
                avatar.textContent = initial;
                email.textContent = user.email;
                status.textContent = 'Signed in';
                if (settingsEmail) settingsEmail.value = user.email;
            } else {
                avatar.textContent = 'U';
                email.textContent = 'user@example.com';
                status.textContent = 'Signed out';
                if (settingsEmail) settingsEmail.value = '';
            }
        }

        function showAuthError(form, message) {
            const errorEl = document.getElementById(`${form}-error`);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showAuthSuccess(message) {
            const successEl = document.getElementById('signup-success');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideAuthErrors() {
            document.querySelectorAll('.auth-error, .auth-success').forEach(el => {
                el.style.display = 'none';
            });
        }

        function loadUserData() {
            if (!currentUser || !isFirebaseInitialized) return;
            
            console.log('Loading user data...');
            
            // Load records, staff warnings, and staff members in parallel
            Promise.all([
                db.collection('users').doc(currentUser.uid).collection('safetyRecords')
                    .orderBy('date', 'desc')
                    .get(),
                db.collection('users').doc(currentUser.uid).collection('staffWarnings')
                    .get(),
                db.collection('users').doc(currentUser.uid).collection('staffMembers')
                    .get()
            ]).then(([recordsSnapshot, warningsSnapshot, staffSnapshot]) => {
                // Load records
                records = [];
                recordsSnapshot.forEach((doc) => {
                    records.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Load staff warnings
                staffWarnings = {};
                warningsSnapshot.forEach((doc) => {
                    staffWarnings[doc.id] = doc.data();
                });
                
                // Load staff members
                staffMembers = [];
                staffSnapshot.forEach((doc) => {
                    staffMembers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Loaded ${records.length} records, ${Object.keys(staffWarnings).length} staff warnings, and ${staffMembers.length} staff members for user`);
                updateDashboard();
                updateTimeline();
                updateStaffWarnings();
                updateStaffList();
                setupStaffSelector();
            }).catch((error) => {
                console.error('Error loading user data:', error);
            });
        }

        // Staff Warning System Functions
        function updateStaffWarning(staffName) {
            if (!currentUser || !isFirebaseInitialized || !staffName.trim()) return;
            
            // Parse comma-separated names
            const staffNames = staffName.split(',').map(name => name.trim()).filter(name => name.length > 0);
            
            staffNames.forEach(individualName => {
                const normalizedName = individualName.toLowerCase();
                const displayName = individualName;
                
                // Increment count for this staff member
                if (staffWarnings[normalizedName]) {
                    staffWarnings[normalizedName].count++;
                    staffWarnings[normalizedName].lastIncident = new Date().toISOString();
                } else {
                    staffWarnings[normalizedName] = {
                        name: displayName,
                        count: 1,
                        firstIncident: new Date().toISOString(),
                        lastIncident: new Date().toISOString(),
                        warningLevel: getWarningLevel(1)
                    };
                }
                
                // Always recalculate warning level based on current count
                staffWarnings[normalizedName].warningLevel = getWarningLevel(staffWarnings[normalizedName].count);
                
                // Save to Firebase
                saveStaffWarningToFirebase(normalizedName);
            });
            
            // Update UI
            updateStaffWarnings();
        }

        function getWarningLevel(count) {
            if (count >= 10) return 'critical';
            if (count >= 7) return 'high';
            if (count >= 4) return 'medium';
            if (count >= 2) return 'low';
            return 'none';
        }

        function getWarningColor(level) {
            const colors = {
                'critical': '#dc3545',
                'high': '#fd7e14',
                'medium': '#ffc107',
                'low': '#28a745',
                'none': '#6c757d'
            };
            return colors[level] || '#6c757d';
        }

        function getWarningIcon(level) {
            const icons = {
                'critical': '🚨',
                'high': '⚠️',
                'medium': '⚡',
                'low': '📝',
                'none': '✅'
            };
            return icons[level] || '📋';
        }

        function getWarningLevelDescription(level) {
            const descriptions = {
                'critical': '🚨 CRITICAL: 10+ incidents - Immediate intervention required',
                'high': '⚠️ HIGH: 7-9 incidents - Additional training and supervision needed',
                'medium': '⚡ MEDIUM: 4-6 incidents - Monitor closely and provide support',
                'low': '📝 LOW: 2-3 incidents - Minor pattern detected',
                'none': '✅ NO WARNING: 1 incident - Normal occurrence'
            };
            return descriptions[level] || '📋 UNKNOWN: Pattern unclear';
        }

        async function saveStaffWarningToFirebase(staffKey) {
            if (!currentUser || !isFirebaseInitialized) return;
            
            try {
                const staffData = staffWarnings[staffKey];
                if (staffData) {
                    await db.collection('users').doc(currentUser.uid).collection('staffWarnings').doc(staffKey).set(staffData);
                } else {
                    // Remove from Firebase if count is 0
                    await db.collection('users').doc(currentUser.uid).collection('staffWarnings').doc(staffKey).delete();
                }
            } catch (error) {
                console.error('Error saving staff warning to Firebase:', error);
            }
        }

        function updateStaffWarnings() {
            // Update both dashboard and staff warnings section containers
            const containers = [
                document.getElementById('staff-warnings-container'),
                document.getElementById('dashboard-staff-warnings-container')
            ];
            
            // Always recalculate warning levels for all staff members to ensure accuracy
            Object.keys(staffWarnings).forEach(staffKey => {
                if (staffWarnings[staffKey]) {
                    const currentCount = staffWarnings[staffKey].count;
                    const calculatedLevel = getWarningLevel(currentCount);
                    
                    // Update warning level if it's different
                    if (staffWarnings[staffKey].warningLevel !== calculatedLevel) {
                        console.log(`Updating ${staffWarnings[staffKey].name}: ${staffWarnings[staffKey].warningLevel} → ${calculatedLevel} (count: ${currentCount})`);
                        staffWarnings[staffKey].warningLevel = calculatedLevel;
                        
                        // Save the updated warning level to Firebase
                        if (currentUser && isFirebaseInitialized) {
                            saveStaffWarningToFirebase(staffKey);
                        }
                    }
                }
            });
            
            const staffWithWarnings = Object.values(staffWarnings).filter(staff => staff.count > 0);
            
            containers.forEach(container => {
                if (!container) return;
                
                if (staffWithWarnings.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No staff warnings at this time.</p>';
                    return;
                }
                
                // Sort by count (highest first)
                const sortedStaff = [...staffWithWarnings].sort((a, b) => b.count - a.count);
                
                container.innerHTML = sortedStaff.map(staff => `
                    <div class="staff-warning-item" style="
                        background: rgba(255, 255, 255, 0.9);
                        padding: 20px;
                        border-radius: 15px;
                        margin-bottom: 15px;
                        border-left: 5px solid ${getWarningColor(staff.warningLevel)};
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    " onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                        
                        <!-- Warning level indicator -->
                        <div style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            background: ${getWarningColor(staff.warningLevel)};
                            color: white;
                            padding: 5px 15px;
                            border-radius: 0 15px 0 15px;
                            font-size: 0.8rem;
                            font-weight: bold;
                            text-transform: uppercase;
                        ">
                            ${staff.warningLevel}
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2.5rem;">${getWarningIcon(staff.warningLevel)}</div>
                            <div style="flex: 1;">
                                <h3 style="color: #2c3e50; margin-bottom: 8px; font-size: 1.3rem;">${staff.name}</h3>
                                <div style="display: flex; gap: 20px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <div style="
                                        background: ${getWarningColor(staff.warningLevel)}20;
                                        padding: 8px 15px;
                                        border-radius: 20px;
                                        border: 1px solid ${getWarningColor(staff.warningLevel)}40;
                                    ">
                                        <strong style="color: ${getWarningColor(staff.warningLevel)};">${staff.count}</strong> 
                                        <span style="color: #666; font-size: 0.9rem;">${staff.count === 1 ? 'Incident' : 'Incidents'}</span>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 8px 15px;
                                        border-radius: 20px;
                                        border: 1px solid #e9ecef;
                                    ">
                                        <span style="color: #666; font-size: 0.9rem;">
                                            <strong>First:</strong> ${formatDate(staff.firstIncident)}
                                        </span>
                                    </div>
                                    <div style="
                                        background: #f8f9fa;
                                        padding: 8px 15px;
                                        border-radius: 20px;
                                        border: 1px solid #e9ecef;
                                    ">
                                        <span style="color: #666; font-size: 0.9rem;">
                                            <strong>Last:</strong> ${formatDate(staff.lastIncident)}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Warning level description -->
                                <div style="
                                    background: ${getWarningColor(staff.warningLevel)}10;
                                    padding: 10px;
                                    border-radius: 8px;
                                    border-left: 3px solid ${getWarningColor(staff.warningLevel)};
                                ">
                                    <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                        <strong>${getWarningLevelDescription(staff.warningLevel)}</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        // Reset staff warnings function
        function resetStaffWarnings() {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to reset staff warnings');
                return;
            }
            
            const confirmMessage = `Are you sure you want to reset ALL staff warnings?\n\nThis will permanently delete all staff incident tracking data and cannot be undone.\n\nThis action is irreversible.`;
            
            if (confirm(confirmMessage)) {
                // Clear local data
                staffWarnings = {};
                
                // Clear from Firebase
                db.collection('users').doc(currentUser.uid).collection('staffWarnings')
                    .get()
                    .then((snapshot) => {
                        const batch = db.batch();
                        snapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    })
                    .then(() => {
                        updateStaffWarnings();
                        updateDashboard();
                        alert('✅ Staff warnings have been reset successfully!');
                    })
                    .catch((error) => {
                        console.error('Error resetting staff warnings:', error);
                        alert('❌ Failed to reset staff warnings. Please try again.');
                    });
            }
        }

        // Initialize staff warnings from existing records
        function initializeStaffWarningsFromRecords() {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to initialize staff warnings');
                return;
            }
            
            const confirmMessage = `This will scan all existing records and populate the staff warning system with historical data.\n\nThis may take a moment depending on the number of records.\n\nContinue?`;
            
            if (confirm(confirmMessage)) {
                // Show loading indicator
                const container = document.getElementById('staff-warnings-container');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 2rem; margin-bottom: 10px;">⏳</div>Scanning existing records...</div>';
                }
                
                // Clear existing warnings
                staffWarnings = {};
                
                // Process all records to build staff warnings
                const staffCounts = {};
                
                records.forEach(record => {
                    if (record.staffMember && record.staffMember.trim()) {
                        // Parse comma-separated names
                        const staffNames = record.staffMember.split(',').map(name => name.trim()).filter(name => name.length > 0);
                        
                        staffNames.forEach(individualName => {
                            const normalizedName = individualName.toLowerCase();
                            const displayName = individualName;
                            
                            if (!staffCounts[normalizedName]) {
                                staffCounts[normalizedName] = {
                                    name: displayName,
                                    count: 0,
                                    firstIncident: record.date,
                                    lastIncident: record.date,
                                    records: []
                                };
                            }
                            
                            staffCounts[normalizedName].count++;
                            staffCounts[normalizedName].records.push(record);
                            
                            // Update first and last incident dates
                            if (new Date(record.date) < new Date(staffCounts[normalizedName].firstIncident)) {
                                staffCounts[normalizedName].firstIncident = record.date;
                            }
                            if (new Date(record.date) > new Date(staffCounts[normalizedName].lastIncident)) {
                                staffCounts[normalizedName].lastIncident = record.date;
                            }
                        });
                    }
                });
                
                // Convert to staff warnings format
                Object.keys(staffCounts).forEach(staffKey => {
                    const staffData = staffCounts[staffKey];
                    staffWarnings[staffKey] = {
                        name: staffData.name,
                        count: staffData.count,
                        firstIncident: staffData.firstIncident,
                        lastIncident: staffData.lastIncident,
                        warningLevel: getWarningLevel(staffData.count)
                    };
                });
                
                // Save all staff warnings to Firebase
                const batch = db.batch();
                Object.keys(staffWarnings).forEach(staffKey => {
                    const docRef = db.collection('users').doc(currentUser.uid).collection('staffWarnings').doc(staffKey);
                    batch.set(docRef, staffWarnings[staffKey]);
                });
                
                batch.commit()
                    .then(() => {
                        updateStaffWarnings();
                        updateDashboard();
                        alert(`✅ Staff warnings initialized successfully!\n\nFound ${Object.keys(staffWarnings).length} staff members with ${Object.values(staffWarnings).reduce((sum, staff) => sum + staff.count, 0)} total incidents.`);
                    })
                    .catch((error) => {
                        console.error('Error saving staff warnings to Firebase:', error);
                        alert('❌ Failed to save staff warnings to Firebase. Please try again.');
                    });
            }
        }

        // Clean up existing staff warnings data
        function cleanupStaffWarnings() {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to cleanup staff warnings');
                return;
            }
            
            const confirmMessage = `This will clean up existing staff warnings by properly parsing comma-separated names.\n\nThis will:\n- Split entries like "Michelle, Merchandisers" into individual staff members\n- Recalculate all incident counts correctly\n- Remove duplicate entries\n\nContinue?`;
            
            if (confirm(confirmMessage)) {
                // Show loading indicator
                const container = document.getElementById('staff-warnings-container');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 2rem; margin-bottom: 10px;">🧹</div>Cleaning up staff warnings...</div>';
                }
                
                // Get all existing warnings
                db.collection('users').doc(currentUser.uid).collection('staffWarnings')
                    .get()
                    .then((snapshot) => {
                        const oldWarnings = {};
                        snapshot.forEach((doc) => {
                            oldWarnings[doc.id] = doc.data();
                        });
                        
                        // Clear existing warnings
                        staffWarnings = {};
                        
                        // Process each old warning entry
                        Object.keys(oldWarnings).forEach(oldKey => {
                            const oldData = oldWarnings[oldKey];
                            
                            // Check if this is a comma-separated entry that needs splitting
                            if (oldData.name.includes(',')) {
                                // Split the names
                                const staffNames = oldData.name.split(',').map(name => name.trim()).filter(name => name.length > 0);
                                
                                // Distribute the count among individual names
                                const countPerPerson = Math.ceil(oldData.count / staffNames.length);
                                
                                staffNames.forEach(individualName => {
                                    const normalizedName = individualName.toLowerCase();
                                    
                                    if (staffWarnings[normalizedName]) {
                                        staffWarnings[normalizedName].count += countPerPerson;
                                        // Keep the earliest first incident and latest last incident
                                        if (new Date(oldData.firstIncident) < new Date(staffWarnings[normalizedName].firstIncident)) {
                                            staffWarnings[normalizedName].firstIncident = oldData.firstIncident;
                                        }
                                        if (new Date(oldData.lastIncident) > new Date(staffWarnings[normalizedName].lastIncident)) {
                                            staffWarnings[normalizedName].lastIncident = oldData.lastIncident;
                                        }
                                    } else {
                                        staffWarnings[normalizedName] = {
                                            name: individualName,
                                            count: countPerPerson,
                                            firstIncident: oldData.firstIncident,
                                            lastIncident: oldData.lastIncident,
                                            warningLevel: getWarningLevel(countPerPerson)
                                        };
                                    }
                                });
                            } else {
                                // Single name, keep as is
                                const normalizedName = oldData.name.toLowerCase();
                                staffWarnings[normalizedName] = oldData;
                            }
                        });
                        
                        // Delete all old warnings and save new ones
                        const batch = db.batch();
                        
                        // Delete old entries
                        snapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        
                        // Add new entries
                        Object.keys(staffWarnings).forEach(staffKey => {
                            const docRef = db.collection('users').doc(currentUser.uid).collection('staffWarnings').doc(staffKey);
                            batch.set(docRef, staffWarnings[staffKey]);
                        });
                        
                        return batch.commit();
                    })
                    .then(() => {
                        updateStaffWarnings();
                        updateDashboard();
                        alert(`✅ Staff warnings cleaned up successfully!\n\nProcessed ${Object.keys(staffWarnings).length} individual staff members.`);
                    })
                    .catch((error) => {
                        console.error('Error cleaning up staff warnings:', error);
                        alert('❌ Failed to cleanup staff warnings. Please try again.');
                    });
            }
        }

        // Force refresh warning levels for all staff
        function refreshWarningLevels() {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to refresh warning levels');
                return;
            }
            
            const confirmMessage = `This will recalculate warning levels for all staff members based on their current incident counts.\n\nThis ensures all warning levels are accurate and up-to-date.\n\nContinue?`;
            
            if (confirm(confirmMessage)) {
                // Show loading indicator
                const container = document.getElementById('staff-warnings-container');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 2rem; margin-bottom: 10px;">🔄</div>Refreshing warning levels...</div>';
                }
                
                // Recalculate warning levels for all staff
                Object.keys(staffWarnings).forEach(staffKey => {
                    if (staffWarnings[staffKey]) {
                        staffWarnings[staffKey].warningLevel = getWarningLevel(staffWarnings[staffKey].count);
                    }
                });
                
                // Save all updated warnings to Firebase
                const batch = db.batch();
                Object.keys(staffWarnings).forEach(staffKey => {
                    const docRef = db.collection('users').doc(currentUser.uid).collection('staffWarnings').doc(staffKey);
                    batch.set(docRef, staffWarnings[staffKey]);
                });
                
                batch.commit()
                    .then(() => {
                        updateStaffWarnings();
                        updateDashboard();
                        alert(`✅ Warning levels refreshed successfully!\n\nUpdated ${Object.keys(staffWarnings).length} staff members.`);
                    })
                    .catch((error) => {
                        console.error('Error refreshing warning levels:', error);
                        alert('❌ Failed to refresh warning levels. Please try again.');
                    });
            }
        }

        // Staff Management Functions
        function addStaffMember() {
            const input = document.getElementById('new-staff-name');
            const name = input.value.trim();
            
            if (!name) {
                alert('❌ Please enter a staff member name');
                return;
            }
            
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to add staff members');
                return;
            }
            
            // Check if staff member already exists
            if (staffMembers.some(staff => staff.name.toLowerCase() === name.toLowerCase())) {
                alert('❌ This staff member already exists');
                return;
            }
            
            const staffMember = {
                id: Date.now().toString(),
                name: name,
                addedDate: new Date().toISOString(),
                userId: currentUser.uid
            };
            
            // Save to Firebase
            db.collection('users').doc(currentUser.uid).collection('staffMembers').doc(staffMember.id).set(staffMember)
                .then(() => {
                    // Add to local array
                    staffMembers.push(staffMember);
                    
                    // Update UI
                    updateStaffList();
                    setupStaffSelector();
                    
                    // Clear input
                    input.value = '';
                    
                    alert(`✅ Added ${name} to staff list`);
                })
                .catch((error) => {
                    console.error('Error adding staff member:', error);
                    alert('❌ Failed to add staff member. Please try again.');
                });
        }

        function removeStaffMember(staffId) {
            const staffMember = staffMembers.find(staff => staff.id === staffId);
            if (!staffMember) return;
            
            const confirmMessage = `Are you sure you want to remove ${staffMember.name} from the staff list?\n\nThis will not affect existing records, but they will no longer appear in the dropdown for new records.`;
            
            if (confirm(confirmMessage)) {
                // Remove from Firebase
                db.collection('users').doc(currentUser.uid).collection('staffMembers').doc(staffId).delete()
                    .then(() => {
                        // Remove from local array
                        staffMembers = staffMembers.filter(staff => staff.id !== staffId);
                        
                        // Update UI
                        updateStaffList();
                        setupStaffSelector();
                        
                        alert(`✅ Removed ${staffMember.name} from staff list`);
                    })
                    .catch((error) => {
                        console.error('Error removing staff member:', error);
                        alert('❌ Failed to remove staff member. Please try again.');
                    });
            }
        }

        function updateStaffList() {
            const container = document.getElementById('staff-list');
            if (!container) return;
            
            if (staffMembers.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No staff members added yet. Add your first staff member above.</p>';
                return;
            }
            
            container.innerHTML = staffMembers.map(staff => `
                <div class="staff-list-item">
                    <div class="staff-name">${staff.name}</div>
                    <button class="remove-staff-btn" onclick="removeStaffMember('${staff.id}')">Remove</button>
                </div>
            `).join('');
        }

        function importDefaultStaff() {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to import staff members');
                return;
            }
            
            const defaultStaff = [
                'John Smith',
                'Sarah Johnson',
                'Michael Brown',
                'Emily Davis',
                'David Wilson',
                'Lisa Anderson',
                'Robert Taylor',
                'Jennifer Martinez',
                'Christopher Garcia',
                'Amanda Rodriguez',
                'James Thompson'
            ];
            
            const confirmMessage = `This will add ${defaultStaff.length} sample staff members to your list.\n\nYou can edit or remove them later.\n\nContinue?`;
            
            if (confirm(confirmMessage)) {
                const batch = db.batch();
                const newStaffMembers = [];
                
                defaultStaff.forEach((name, index) => {
                    const staffId = `default-${Date.now()}-${index}`;
                    const staffMember = {
                        id: staffId,
                        name: name,
                        addedDate: new Date().toISOString(),
                        userId: currentUser.uid
                    };
                    
                    const docRef = db.collection('users').doc(currentUser.uid).collection('staffMembers').doc(staffId);
                    batch.set(docRef, staffMember);
                    newStaffMembers.push(staffMember);
                });
                
                batch.commit()
                    .then(() => {
                        // Add to local array
                        staffMembers.push(...newStaffMembers);
                        
                        // Update UI
                        updateStaffList();
                        setupStaffSelector();
                        
                        alert(`✅ Added ${defaultStaff.length} sample staff members`);
                    })
                    .catch((error) => {
                        console.error('Error importing staff members:', error);
                        alert('❌ Failed to import staff members. Please try again.');
                    });
            }
        }

        function clearAllStaff() {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to clear staff members');
                return;
            }
            
            if (staffMembers.length === 0) {
                alert('❌ No staff members to clear');
                return;
            }
            
            const confirmMessage = `Are you sure you want to remove ALL ${staffMembers.length} staff members?\n\nThis will not affect existing records, but staff will no longer appear in the dropdown for new records.\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                const batch = db.batch();
                
                staffMembers.forEach(staff => {
                    const docRef = db.collection('users').doc(currentUser.uid).collection('staffMembers').doc(staff.id);
                    batch.delete(docRef);
                });
                
                batch.commit()
                    .then(() => {
                        // Clear local array
                        staffMembers = [];
                        
                        // Update UI
                        updateStaffList();
                        setupStaffSelector();
                        
                        alert('✅ All staff members cleared');
                    })
                    .catch((error) => {
                        console.error('Error clearing staff members:', error);
                        alert('❌ Failed to clear staff members. Please try again.');
                    });
            }
        }

        // Staff Selector Functions
        function setupStaffSelector() {
            const input = document.getElementById('staff-member-input');
            const dropdown = document.getElementById('staff-dropdown');
            
            if (!input || !dropdown) return;
            
            // Clear any existing event listeners
            input.removeEventListener('input', handleStaffInput);
            input.removeEventListener('focus', showStaffDropdown);
            input.removeEventListener('blur', hideStaffDropdown);
            
            // Add event listeners
            input.addEventListener('input', handleStaffInput);
            input.addEventListener('focus', showStaffDropdown);
            input.addEventListener('blur', hideStaffDropdown);
            
            // Initialize dropdown
            updateStaffDropdown();
        }

        function handleStaffInput() {
            const input = document.getElementById('staff-member-input');
            const query = input.value.toLowerCase();
            
            updateStaffDropdown(query);
        }

        function showStaffDropdown() {
            const dropdown = document.getElementById('staff-dropdown');
            if (dropdown && staffMembers.length > 0) {
                dropdown.style.display = 'block';
                updateStaffDropdown();
            }
        }

        function hideStaffDropdown() {
            // Delay hiding to allow for clicks
            setTimeout(() => {
                const dropdown = document.getElementById('staff-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 200);
        }

        function updateStaffDropdown(query = '') {
            const dropdown = document.getElementById('staff-dropdown');
            if (!dropdown) return;
            
            const filteredStaff = staffMembers.filter(staff => 
                staff.name.toLowerCase().includes(query.toLowerCase()) &&
                !selectedStaffMembers.some(selected => selected.id === staff.id)
            );
            
            if (filteredStaff.length === 0) {
                dropdown.innerHTML = '<div class="staff-dropdown-item">No staff members found</div>';
                return;
            }
            
            dropdown.innerHTML = filteredStaff.map(staff => `
                <div class="staff-dropdown-item" onclick="selectStaffMember('${staff.id}')">
                    ${staff.name}
                </div>
            `).join('');
        }

        function selectStaffMember(staffId) {
            const staffMember = staffMembers.find(staff => staff.id === staffId);
            if (!staffMember) return;
            
            // Add to selected staff
            if (!selectedStaffMembers.some(staff => staff.id === staffId)) {
                selectedStaffMembers.push(staffMember);
                updateSelectedStaffTags();
                updateHiddenInput();
            }
            
            // Clear input and hide dropdown
            const input = document.getElementById('staff-member-input');
            if (input) {
                input.value = '';
            }
            hideStaffDropdown();
        }

        function removeSelectedStaff(staffId) {
            selectedStaffMembers = selectedStaffMembers.filter(staff => staff.id !== staffId);
            updateSelectedStaffTags();
            updateHiddenInput();
        }

        function updateSelectedStaffTags() {
            const container = document.getElementById('selected-staff-tags');
            if (!container) return;
            
            if (selectedStaffMembers.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = selectedStaffMembers.map(staff => `
                <div class="staff-tag">
                    <span>${staff.name}</span>
                    <button class="staff-tag-remove" onclick="removeSelectedStaff('${staff.id}')">×</button>
                </div>
            `).join('');
        }

        function updateHiddenInput() {
            const hiddenInput = document.getElementById('staff-member');
            if (hiddenInput) {
                const staffNames = selectedStaffMembers.map(staff => staff.name).join(', ');
                hiddenInput.value = staffNames;
            }
        }

        function clearStaffSelection() {
            selectedStaffMembers = [];
            updateSelectedStaffTags();
            updateHiddenInput();
            
            const input = document.getElementById('staff-member-input');
            if (input) {
                input.value = '';
            }
        }

        // Debug function to test warning system
        function testWarningSystem() {
            console.log('=== WARNING SYSTEM DEBUG ===');
            console.log('Current staff warnings:', staffWarnings);
            
            // Test warning level calculations
            const testCounts = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 15];
            console.log('Testing warning level calculations:');
            testCounts.forEach(count => {
                const level = getWarningLevel(count);
                console.log(`Count: ${count} → Level: ${level} (${getWarningLevelDescription(level)})`);
            });
            
            // Check if any staff have incorrect warning levels
            Object.keys(staffWarnings).forEach(staffKey => {
                const staff = staffWarnings[staffKey];
                const expectedLevel = getWarningLevel(staff.count);
                if (staff.warningLevel !== expectedLevel) {
                    console.warn(`⚠️ WARNING: ${staff.name} has count ${staff.count} but level ${staff.warningLevel} (should be ${expectedLevel})`);
                } else {
                    console.log(`✅ ${staff.name}: ${staff.count} incidents → ${staff.warningLevel} (correct)`);
                }
            });
            
            // Show summary
            const staffWithWarnings = Object.values(staffWarnings).filter(staff => staff.count > 0);
            console.log(`\nSummary: ${staffWithWarnings.length} staff members with warnings`);
            staffWithWarnings.forEach(staff => {
                console.log(`- ${staff.name}: ${staff.count} incidents (${staff.warningLevel})`);
            });
            
            alert('Check browser console for warning system debug information');
        }

        // Sync notification functions
        function showSyncNotification(message, type = 'info') {
            const notification = document.getElementById('sync-notification');
            const messageEl = document.getElementById('sync-message');
            
            if (!notification || !messageEl) {
                console.log('Sync status:', message);
                return;
            }
            
            messageEl.textContent = message;
            notification.style.display = 'block';
            
            // Color coding
            if (type === 'success') {
                notification.style.background = 'rgba(40, 167, 69, 0.95)';
                notification.style.color = 'white';
            } else if (type === 'error') {
                notification.style.background = 'rgba(220, 53, 69, 0.95)';
                notification.style.color = 'white';
            } else {
                notification.style.background = 'rgba(255, 255, 255, 0.95)';
                notification.style.color = '#333';
            }
        }

        function hideSyncNotification() {
            const notification = document.getElementById('sync-notification');
            if (notification) {
                notification.style.display = 'none';
            }
        }

        // Mass Delete Functions
        function toggleMassDelete() {
            const checkboxes = document.querySelectorAll('.mass-delete-checkbox');
            const massDeleteBtn = document.querySelector('button[onclick="toggleMassDelete()"]');
            
            if (checkboxes[0].style.display === 'none') {
                // Enable mass delete mode
                checkboxes.forEach(cb => cb.style.display = 'block');
                massDeleteBtn.textContent = '✅ Confirm Delete';
                massDeleteBtn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                updateMassDeleteButton();
            } else {
                // Execute mass delete
                const selectedRecords = getSelectedRecords();
                if (selectedRecords.length === 0) {
                    alert('❌ Please select at least one record to delete.');
                    return;
                }
                
                const confirmMessage = `Are you sure you want to delete ${selectedRecords.length} record(s)?\n\nThis action cannot be undone.`;
                if (confirm(confirmMessage)) {
                    massDeleteRecords(selectedRecords);
                }
            }
        }

        function getSelectedRecords() {
            const checkboxes = document.querySelectorAll('.mass-delete-checkbox input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.id.replace('select-', ''));
        }

        function updateMassDeleteButton() {
            const selectedCount = getSelectedRecords().length;
            const massDeleteBtn = document.querySelector('button[onclick="toggleMassDelete()"]');
            
            if (selectedCount > 0) {
                massDeleteBtn.textContent = `✅ Delete ${selectedCount} Record(s)`;
            } else {
                massDeleteBtn.textContent = '✅ Confirm Delete';
            }
        }

        async function massDeleteRecords(recordIds) {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to delete records');
                return;
            }

            const batch = db.batch();
            
            for (const recordId of recordIds) {
                const docRef = db.collection('users').doc(currentUser.uid).collection('safetyRecords').doc(recordId);
                batch.delete(docRef);
            }

            try {
                await batch.commit();
                
                // Remove from local records
                const deletedRecords = records.filter(r => recordIds.includes(r.id));
                records = records.filter(r => !recordIds.includes(r.id));
                
                // Note: Staff warnings are NOT decremented when records are deleted
                // This maintains accountability and pattern tracking
                
                // Update displays
                updateDashboard();
                updateTimeline();
                
                // Reset mass delete mode
                const checkboxes = document.querySelectorAll('.mass-delete-checkbox');
                checkboxes.forEach(cb => cb.style.display = 'none');
                const massDeleteBtn = document.querySelector('button[onclick="toggleMassDelete()"]');
                massDeleteBtn.textContent = '🗑️ Mass Delete';
                massDeleteBtn.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                
                alert(`✅ Successfully deleted ${recordIds.length} record(s)!`);
                
            } catch (error) {
                console.error('Error deleting records:', error);
                alert('❌ Failed to delete some records. Please try again.');
            }
        }

        // Helper function to calculate space needed for a record
        function calculateRecordSpace(record, doc) {
            let space = 0;
            
            // Header space
            space += 16; // Increased for better spacing
            
            // Record details space
            space += 12; // Increased for better spacing
            
            // Description space
            const descriptionLines = doc.splitTextToSize(record.description, 170);
            space += 8 + (descriptionLines.length * 4) + 8; // Increased spacing
            
            // Photos space
            if (record.photos && record.photos.length > 0) {
                space += 12; // Header
                const photosPerRow = 3;
                const photoHeight = 35; // Updated to match new dimensions
                const totalRows = Math.ceil(record.photos.length / photosPerRow);
                space += (totalRows * (photoHeight + 12)) + 10; // Increased spacing
            }
            
            // Separator space
            space += 15; // Increased for better separation
            
            return space;
        }

        // PDF Export Functions
        async function exportToPDF() {
            if (!currentUser) {
                alert('Please sign in to export data');
                return;
            }

            if (records.length === 0) {
                alert('No records to export');
                return;
            }

            // Show loading message
            const exportBtn = document.querySelector('button[onclick="exportToPDF()"]');
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'Generating PDF...';
            exportBtn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Enhanced header with gradient effect
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, 210, 35, 'F');
                
                // Add subtle pattern overlay
                for (let i = 0; i < 210; i += 5) {
                    doc.setDrawColor(255, 255, 255, 0.1);
                    doc.line(i, 0, i, 35);
                }
                
                // Main title with shadow effect
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.text('Food Safety Manager', 105, 18, { align: 'center' });
                
                // Subtitle
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Compliance Report - ${new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`, 105, 28, { align: 'center' });
                
                // Add decorative line
                doc.setDrawColor(255, 255, 255);
                doc.setLineWidth(0.5);
                doc.line(30, 32, 180, 32);
                
                // Enhanced user info section with background
                doc.setFillColor(248, 249, 250);
                doc.rect(15, 45, 180, 25, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.rect(15, 45, 180, 25, 'S');
                
                doc.setTextColor(44, 62, 80);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Report Information:', 20, 52);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text(`Generated by: ${currentUser.email}`, 20, 58);
                doc.text(`Total Records: ${records.length}`, 20, 63);
                
                // Add summary statistics
                const thisMonth = new Date();
                thisMonth.setDate(1);
                const thisMonthRecords = records.filter(r => new Date(r.date) >= thisMonth);
                const highPriorityRecords = records.filter(r => r.priority === 'high');
                const recordsWithPhotos = records.filter(r => r.photos.length > 0);
                
                doc.text(`This Month: ${thisMonthRecords.length}`, 120, 58);
                doc.text(`High Priority: ${highPriorityRecords.length}`, 120, 63);
                doc.text(`With Photos: ${recordsWithPhotos.length}`, 120, 68);
                
                let yPosition = 90; // Start a bit lower to ensure proper spacing
                let pageNumber = 1;
                
                for (let i = 0; i < records.length; i++) {
                    const record = records[i];
                    
                    // Calculate estimated space needed for this record
                    const estimatedSpace = calculateRecordSpace(record, doc);
                    
                                // Check if we need a new page - ensure each record fits nicely on one page
            if (yPosition + estimatedSpace > 240) {
                        doc.addPage();
                        pageNumber++;
                        yPosition = 20;
                        
                        // Add page header for subsequent pages
                        doc.setFillColor(102, 126, 234);
                        doc.rect(0, 0, 210, 25, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(16);
                        doc.setFont(undefined, 'bold');
                        doc.text('Food Safety Manager - Compliance Report', 105, 12, { align: 'center' });
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Page ${pageNumber}`, 105, 20, { align: 'center' });
                        yPosition = 40; // Start new pages a bit lower for better spacing
                    }
                    
                    // --- Draw border around record ---
                    const recordTop = yPosition - 3;
                    let recordHeight = estimatedSpace + 6; // Add extra space for padding
                    doc.setDrawColor(225, 232, 237); // #e1e8ed
                    doc.setLineWidth(0.8);
                    doc.roundedRect(12, recordTop, 186, recordHeight, 6, 6, 'S');
                    let innerX = 18; // for padding
                    let contentWidth = 174;
                    let sectionY = yPosition + 4; // Add more top padding to stay inside border

                    // --- Record header (category, number, priority) ---
                    // Enhanced record header with category color - more compact
                    const categoryColors = {
                        'food-safety': [255, 107, 107],
                        'health-safety': [78, 205, 196],
                        'cleaning': [69, 183, 73],
                        'training': [247, 147, 30],
                        'equipment': [155, 89, 182]
                    };
                    
                    const categoryColor = categoryColors[record.category] || [102, 126, 234];
                    doc.setFillColor(categoryColor[0], categoryColor[1], categoryColor[2], 0.15);
                    doc.rect(innerX, sectionY - 4, contentWidth, 8, 'F');
                    doc.setDrawColor(categoryColor[0], categoryColor[1], categoryColor[2]);
                    doc.setLineWidth(0.5);
                    doc.rect(innerX, sectionY - 4, contentWidth, 8, 'S');
                    
                    // Record number and category - more compact
                    doc.setTextColor(categoryColor[0], categoryColor[1], categoryColor[2]);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Record ${i + 1}`, innerX + 2, sectionY);
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${getCategoryName(record.category)}`, innerX + 62, sectionY);
                    
                    // Priority badge - more prominent and colored
                    const priorityColors = {
                        'low': [255, 193, 7],      // yellow
                        'medium': [255, 140, 0],  // orange
                        'high': [220, 53, 69]     // red
                    };
                    const priorityColor = priorityColors[record.priority] || [108, 117, 125];
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(priorityColor[0], priorityColor[1], priorityColor[2]);
                    doc.text(record.priority.toUpperCase(), innerX + contentWidth - 10, sectionY, { align: 'center' });
                    doc.setTextColor(44, 62, 80); // reset for rest
                    sectionY += 12;
                    
                    // --- Record details (date, staff, location) ---
                    // Left column
                    doc.setFont(undefined, 'bold');
                    doc.text('Date:', innerX, sectionY);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDate(record.date), innerX + 25, sectionY);
                    doc.setFont(undefined, 'bold');
                    doc.text('Staff:', innerX, sectionY + 5);
                    doc.setFont(undefined, 'normal');
                    doc.text(record.staffMember, innerX + 25, sectionY + 5);
                    // Right column
                    doc.setFont(undefined, 'bold');
                    doc.text('Location:', innerX + 100, sectionY);
                    doc.setFont(undefined, 'normal');
                    doc.text(record.location, innerX + 125, sectionY);
                    sectionY += 10;
                    
                    // --- Description section ---
                    doc.setFillColor(247, 250, 253); // #f7fafd
                    const descriptionLines = doc.splitTextToSize(record.description, 170);
                    const descHeight = 12 + descriptionLines.length * 4;
                    doc.roundedRect(innerX, sectionY - 1, contentWidth, descHeight, 3, 3, 'F');
                    doc.setDrawColor(102, 126, 234, 0.2);
                    doc.setLineWidth(0.3);
                    doc.roundedRect(innerX, sectionY - 1, contentWidth, descHeight, 3, 3, 'S');
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.setFontSize(10);
                    doc.text('Description:', innerX + 5, sectionY + 5);
                    sectionY += 12;
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(44, 62, 80);
                    doc.setFontSize(9);
                    doc.text(descriptionLines, innerX + 5, sectionY + 2);
                    sectionY += descriptionLines.length * 4 + 8;
                    
                    // --- Attachments section ---
                    if (record.photos && record.photos.length > 0) {
                        doc.setFillColor(249, 249, 251); // #f9f9fb
                        const attachHeight = 20 + (Math.ceil(record.photos.length / 3) * 47);
                        doc.roundedRect(innerX, sectionY - 1, contentWidth, attachHeight, 3, 3, 'F');
                        doc.setDrawColor(102, 126, 234, 0.2);
                        doc.setLineWidth(0.3);
                        doc.roundedRect(innerX, sectionY - 1, contentWidth, attachHeight, 3, 3, 'S');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(102, 126, 234);
                        doc.setFontSize(10);
                        doc.text(`Attachments (${record.photos.length})`, innerX + 5, sectionY + 5);
                        sectionY += 12;
                        // ... photo grid as before, but use innerX for X ...
                        // ... update sectionY after photos ...
                        // Calculate photos per row (3 photos per row for better visibility)
                        const photosPerRow = 3;
                        const photoWidth = 50;
                        const photoHeight = 35; // Increased height for better visibility
                        const photoSpacing = 10; // Increased spacing for better separation
                        
                        for (let j = 0; j < record.photos.length; j++) {
                            const photo = record.photos[j];
                            const row = Math.floor(j / photosPerRow);
                            const col = j % photosPerRow;
                            const photoX = innerX + (col * (photoWidth + photoSpacing));
                            const photoY = sectionY + (row * (photoHeight + 12)); // Better row spacing
                            
                            // Check if we need a new page - ensure photos fit on same page as record
                            if (photoY > 200) {
                                doc.addPage();
                                pageNumber++;
                                yPosition = 20;
                                
                                // Add page header
                                doc.setFillColor(102, 126, 234);
                                doc.rect(0, 0, 210, 25, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(16);
                                doc.setFont(undefined, 'bold');
                                doc.text('Food Safety Manager - Compliance Report', 105, 12, { align: 'center' });
                                doc.setFontSize(10);
                                doc.setFont(undefined, 'normal');
                                doc.text(`Page ${pageNumber}`, 105, 20, { align: 'center' });
                                yPosition = 40; // Start new pages a bit lower for better spacing
                                continue;
                            }
                            
                            if (photo.isRaw) {
                                // Enhanced RAW file placeholder - more compact
                                doc.setFillColor(102, 126, 234, 0.1);
                                doc.rect(photoX, photoY, photoWidth, photoHeight, 'F');
                                doc.setDrawColor(102, 126, 234);
                                doc.setLineWidth(0.5);
                                doc.rect(photoX, photoY, photoWidth, photoHeight, 'S');
                                
                                doc.setTextColor(102, 126, 234);
                                doc.setFontSize(8);
                                doc.setFont(undefined, 'bold');
                                doc.text('RAW', photoX + photoWidth/2, photoY + 15, { align: 'center' });
                                doc.setFont(undefined, 'normal');
                                doc.setFontSize(7);
                                doc.text(photo.name.split('.').pop().toUpperCase(), photoX + photoWidth/2, photoY + 25, { align: 'center' });
                                doc.setFontSize(6);
                                const displayName = photo.name.length > 15 ? photo.name.substring(0, 15) + '...' : photo.name;
                                doc.text(displayName, photoX + photoWidth/2, photoY + 32, { align: 'center' });
                            } else {
                                try {
                                    // Improved image handling for PDF
                                    const img = new Image();
                                    img.crossOrigin = 'anonymous';
                                    
                                    await new Promise((resolve, reject) => {
                                        img.onload = resolve;
                                        img.onerror = reject;
                                        img.src = photo.data;
                                    });
                                    
                                    // Create canvas with proper dimensions for better quality
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Set canvas size to original image dimensions for best quality
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    
                                    // Draw image at full resolution
                                    ctx.drawImage(img, 0, 0);
                                    
                                    // Convert to data URL with maximum quality
                                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                                    
                                    // Add image to PDF
                                    doc.addImage(imgData, 'JPEG', photoX, photoY, photoWidth, photoHeight);
                                    
                                    // Add border around image
                                    doc.setDrawColor(102, 126, 234);
                                    doc.setLineWidth(0.3);
                                    doc.rect(photoX, photoY, photoWidth, photoHeight, 'S');
                                    
                                    // Add filename below image with better styling
                                    doc.setTextColor(44, 62, 80);
                                    doc.setFontSize(7);
                                    const displayName = photo.name.length > 15 ? photo.name.substring(0, 15) + '...' : photo.name;
                                    doc.text(displayName, photoX + photoWidth/2, photoY + photoHeight + 6, { align: 'center' });
                                    
                                } catch (error) {
                                    console.error('Error adding image to PDF:', error);
                                    // Show error placeholder
                                    doc.setFillColor(220, 53, 69, 0.1);
                                    doc.rect(photoX, photoY, photoWidth, photoHeight, 'F');
                                    doc.setDrawColor(220, 53, 69);
                                    doc.setLineWidth(0.5);
                                    doc.rect(photoX, photoY, photoWidth, photoHeight, 'S');
                                    doc.setTextColor(220, 53, 69);
                                    doc.setFontSize(6);
                                    doc.text('Image Error', photoX + photoWidth/2, photoY + photoHeight/2, { align: 'center' });
                                    doc.text(photo.name.substring(0, 10) + '...', photoX + photoWidth/2, photoY + photoHeight + 4, { align: 'center' });
                                }
                            }
                        }
                        
                        // Update yPosition based on the last photo row - better spacing
                        const totalRows = Math.ceil(record.photos.length / photosPerRow);
                        sectionY += (totalRows * (photoHeight + 12)) + 10; // Better spacing
                    }
                    
                    // Add separator line between records - more appealing
                    doc.setDrawColor(102, 126, 234, 0.2);
                    doc.setLineWidth(0.5);
                    doc.line(innerX, sectionY + 2, innerX + contentWidth, sectionY + 2);
                    sectionY += 15;
                    
                    // Update main yPosition for next record
                    yPosition = sectionY;
                    
                    // Add page number at bottom
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Page ${pageNumber}`, 105, 285, { align: 'center' });
                }
                
                // Add Staff Warnings Section
                const staffWithWarnings = Object.values(staffWarnings).filter(staff => staff.count > 0);
                if (staffWithWarnings.length > 0) {
                    // Always start staff warnings on a new page for better organization
                    doc.addPage();
                    pageNumber++;
                    yPosition = 20;
                    
                    // Add page header
                    doc.setFillColor(102, 126, 234);
                    doc.rect(0, 0, 210, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text('Food Safety Manager - Compliance Report', 105, 12, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${pageNumber}`, 105, 20, { align: 'center' });
                    yPosition = 40;
                    
                    // Staff Warnings Header
                    doc.setFillColor(220, 53, 69, 0.1);
                    doc.rect(15, yPosition - 5, 180, 15, 'F');
                    doc.setDrawColor(220, 53, 69);
                    doc.setLineWidth(0.5);
                    doc.rect(15, yPosition - 5, 180, 15, 'S');
                    
                    doc.setTextColor(220, 53, 69);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Staff Warning System', 20, yPosition + 3);
                    yPosition += 25; // Add more spacing after header
                    
                    // Sort staff by incident count (highest first)
                    staffWithWarnings.sort((a, b) => b.count - a.count);
                    
                    // Staff warnings table
                    let tableY = yPosition;
                    const tableX = 20;
                    const colWidths = [60, 30, 40, 60]; // Name, Count, Level, Last Incident
                    
                    // Table header
                    doc.setFillColor(248, 249, 250);
                    doc.rect(tableX, tableY - 3, 160, 10, 'F');
                    doc.setDrawColor(102, 126, 234);
                    doc.setLineWidth(0.3);
                    doc.rect(tableX, tableY - 3, 160, 10, 'S');
                    
                    doc.setTextColor(44, 62, 80);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Staff Member', tableX + 2, tableY + 2);
                    doc.text('Count', tableX + 65, tableY + 2);
                    doc.text('Level', tableX + 100, tableY + 2);
                    doc.text('Last Incident', tableX + 145, tableY + 2);
                    tableY += 12;
                    
                    // Table rows
                    staffWithWarnings.forEach((staff, index) => {
                        // Check if we need a new page
                        if (tableY > 250) {
                            doc.addPage();
                            pageNumber++;
                            tableY = 40;
                            
                            // Add page header
                            doc.setFillColor(102, 126, 234);
                            doc.rect(0, 0, 210, 25, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(16);
                            doc.setFont(undefined, 'bold');
                            doc.text('Food Safety Manager - Compliance Report', 105, 12, { align: 'center' });
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'normal');
                            doc.text(`Page ${pageNumber}`, 105, 20, { align: 'center' });
                        }
                        
                        // Row background (alternating colors)
                        const rowColor = index % 2 === 0 ? [255, 255, 255] : [248, 249, 250];
                        doc.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                        doc.rect(tableX, tableY - 2, 160, 8, 'F');
                        doc.setDrawColor(225, 232, 237);
                        doc.setLineWidth(0.2);
                        doc.rect(tableX, tableY - 2, 160, 8, 'S');
                        
                        // Staff name
                        doc.setTextColor(44, 62, 80);
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        const displayName = staff.name.length > 15 ? staff.name.substring(0, 15) + '...' : staff.name;
                        doc.text(displayName, tableX + 2, tableY + 2);
                        
                        // Incident count
                        doc.setFont(undefined, 'bold');
                        doc.text(staff.count.toString(), tableX + 65, tableY + 2);
                        
                        // Warning level with color
                        const levelColors = {
                            'critical': [220, 53, 69],
                            'high': [253, 126, 20],
                            'medium': [255, 193, 7],
                            'low': [40, 167, 69]
                        };
                        const levelColor = levelColors[staff.warningLevel] || [108, 117, 125];
                        doc.setTextColor(levelColor[0], levelColor[1], levelColor[2]);
                        doc.setFont(undefined, 'bold');
                        doc.text(staff.warningLevel.toUpperCase(), tableX + 100, tableY + 2);
                        
                        // Last incident date
                        doc.setTextColor(44, 62, 80);
                        doc.setFont(undefined, 'normal');
                        const lastIncidentDate = new Date(staff.lastIncident).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        doc.text(lastIncidentDate, tableX + 145, tableY + 2);
                        
                        tableY += 10;
                    });
                    
                    yPosition = tableY + 10;
                }
                
                // Add professional footer - more compact
                const totalPages = doc.getNumberOfPages();
                for (let page = 1; page <= totalPages; page++) {
                    doc.setPage(page);
                    
                    // Footer background
                    doc.setFillColor(102, 126, 234);
                    doc.rect(0, 275, 210, 15, 'F');
                    
                    // Footer content
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont(undefined, 'normal');
                    doc.text('Food Safety Manager - Compliance Report', 20, 283);
                    doc.text(`Generated on ${new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}`, 20, 289);
                    
                    // Page numbers
                    doc.text(`Page ${page} of ${totalPages}`, 105, 283, { align: 'center' });
                    
                    // Company info (you can customize this)
                    doc.text('© 2024 Food Safety Manager', 150, 283);
                    doc.text('Compliance & Documentation System', 150, 289);
                }
                
                // Save the PDF
                const fileName = `food-safety-compliance-report-${currentUser.email}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                alert('Professional PDF report generated successfully!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                // Restore button
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            }
        }



        function updateFirebaseStatus(connected, message) {
            const indicator = document.getElementById('firebase-indicator');
            const statusText = document.getElementById('firebase-status-text');
            
            indicator.classList.toggle('connected', connected);
            statusText.textContent = message;
        }



        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Activate the corresponding nav button
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                const btnText = btn.textContent;
                if ((sectionId === 'dashboard' && btnText.includes('Dashboard')) ||
                    (sectionId === 'add-record' && btnText.includes('Add Record')) ||
                    (sectionId === 'timeline' && btnText.includes('Timeline')) ||
                    (sectionId === 'staff-warnings' && btnText.includes('Staff Warnings')) ||
                    (sectionId === 'settings' && btnText.includes('Settings'))) {
                    btn.classList.add('active');
                }
            });
            
            // Update staff warnings when viewing that section
            if (sectionId === 'staff-warnings') {
                updateStaffWarnings();
            }
        }

        // Photo upload functionality
        function setupPhotoUpload() {
            const photoUpload = document.querySelector('.photo-upload');
            const photoInput = document.getElementById('photo-input');
            
            // Drag and drop
            photoUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                photoUpload.classList.add('dragover');
            });
            
            photoUpload.addEventListener('dragleave', () => {
                photoUpload.classList.remove('dragover');
            });
            
            photoUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                photoUpload.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            photoInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                // Check if it's an image file or DNG file
                if (file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.dng')) {
                    if (file.name.toLowerCase().endsWith('.dng')) {
                        // Handle DNG files (no compression needed for raw files)
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            selectedPhotos.push({
                                name: file.name,
                                data: e.target.result,
                                type: file.type || 'application/octet-stream',
                                isRaw: true,
                                processing: false
                            });
                            updatePhotoPreview();
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Compress regular image files
                        compressImage(file);
                    }
                } else {
                    alert(`❌ Unsupported file type: ${file.name}. Please upload JPG, PNG, WebP, or DNG files.`);
                }
            });
        }

        function compressImage(file) {
            // Add a placeholder while processing
            const placeholderIndex = selectedPhotos.length;
            selectedPhotos.push({
                name: file.name,
                data: '',
                type: 'image/jpeg',
                isRaw: false,
                processing: true
            });
            updatePhotoPreview();
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calculate new dimensions (max 1200px width/height)
                let { width, height } = img;
                const maxSize = 1200;
                
                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress image
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to compressed JPEG (0.7 quality)
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                
                // Update the placeholder with the compressed image
                selectedPhotos[placeholderIndex] = {
                    name: file.name.replace(/\.[^/.]+$/, '.jpg'), // Change extension to .jpg
                    data: compressedDataUrl,
                    type: 'image/jpeg',
                    isRaw: false,
                    originalSize: file.size,
                    compressedSize: compressedDataUrl.length,
                    processing: false
                };
                
                updatePhotoPreview();
                
                // Show compression info if significant
                const compressionRatio = ((file.size - compressedDataUrl.length) / file.size * 100).toFixed(1);
                if (compressionRatio > 50) {
                    console.log(`Compressed ${file.name}: ${(file.size / 1024 / 1024).toFixed(2)}MB → ${(compressedDataUrl.length / 1024 / 1024).toFixed(2)}MB (${compressionRatio}% reduction)`);
                }
            };
            
            img.onerror = function() {
                // Handle image loading error
                selectedPhotos.splice(placeholderIndex, 1);
                updatePhotoPreview();
                alert(`❌ Failed to process image: ${file.name}`);
            };
            
            img.src = URL.createObjectURL(file);
        }

        function updatePhotoPreview() {
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = selectedPhotos.map((photo, index) => {
                if (photo.processing) {
                    // Show processing indicator
                    return `
                        <div style="position: relative;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(45deg, #ffc107, #ff9800); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                                ⏳<br>Processing
                            </div>
                            <button type="button" onclick="removePhoto(${index})" style="position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `;
                } else if (photo.isRaw) {
                    // Show placeholder for DNG/RAW files
                    return `
                        <div style="position: relative;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(45deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                                📷 RAW<br>${photo.name.split('.').pop().toUpperCase()}
                            </div>
                            <button type="button" onclick="removePhoto(${index})" style="position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `;
                } else {
                    // Show regular image preview with size info
                    const sizeInfo = photo.originalSize ? 
                        `<div style="position: absolute; bottom: 2px; left: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px;">
                            ${(photo.data.length / 1024 / 1024).toFixed(1)}MB
                        </div>` : '';
                    
                    return `
                        <div style="position: relative;">
                            <img src="${photo.data}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            ${sizeInfo}
                            <button type="button" onclick="removePhoto(${index})" style="position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }

        // Form submission
        document.getElementById('record-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('❌ Please sign in to save records');
                return;
            }
            
            // Check if photos are still being processed
            const processingPhotos = selectedPhotos.filter(photo => photo.processing);
            if (processingPhotos.length > 0) {
                alert('⏳ Please wait for photos to finish processing before saving.');
                return;
            }
            
            const record = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                category: document.getElementById('category').value,
                priority: document.getElementById('priority').value,
                staffMember: document.getElementById('staff-member').value,
                location: document.getElementById('location').value,
                description: document.getElementById('description').value,
                photos: [...selectedPhotos],
                userId: currentUser.uid,
                userEmail: currentUser.email
            };
            
            // Save to Firebase
            await saveRecordToFirebase(record);
            
            // Update staff warning system
            updateStaffWarning(record.staffMember);
            
            // Reset form
            this.reset();
            selectedPhotos = [];
            updatePhotoPreview();
            clearStaffSelection();
            
            // Switch to dashboard
            showSection('dashboard');
            document.querySelector('.nav-btn').classList.add('active');
        });

        async function saveRecordToFirebase(record) {
            if (!currentUser || !isFirebaseInitialized) {
                alert('❌ Please sign in to save records');
                return;
            }
            
            // Check payload size before saving
            const recordSize = JSON.stringify(record).length;
            const maxSize = 10000000; // 10MB limit (leaving some buffer)
            
            if (recordSize > maxSize) {
                const sizeMB = (recordSize / 1024 / 1024).toFixed(2);
                alert(`❌ Record too large (${sizeMB}MB). Please reduce the number or size of photos. Maximum size is 10MB.`);
                return;
            }
            
            console.log(`Saving record: ${(recordSize / 1024 / 1024).toFixed(2)}MB`);
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('safetyRecords').doc(record.id).set(record);
                
                // Add to local records
                records.unshift(record);
                
                // Update displays
                updateDashboard();
                updateTimeline();
                
                // Show success message
                alert('✅ Record saved successfully!');
                
                return true;
            } catch (error) {
                console.error('Error saving record:', error);
                if (error.message.includes('payload size exceeds the limit')) {
                    alert('❌ Record too large. Please reduce the number or size of photos and try again.');
                } else {
                    alert('❌ Failed to save record. Please try again.');
                }
                throw error;
            }
        }

        // Dashboard updates
        function updateDashboard() {
            const thisMonth = new Date();
            thisMonth.setDate(1);
            
            const thisMonthRecords = records.filter(r => new Date(r.date) >= thisMonth);
            const highPriorityRecords = records.filter(r => r.priority === 'high');
            const recordsWithPhotos = records.filter(r => r.photos.length > 0);
            const staffWithWarnings = Object.values(staffWarnings).filter(staff => staff.count > 0).length;
            
            document.getElementById('total-records').textContent = records.length;
            document.getElementById('this-month').textContent = thisMonthRecords.length;
            document.getElementById('high-priority').textContent = highPriorityRecords.length;
            document.getElementById('with-photos').textContent = recordsWithPhotos.length;
            document.getElementById('staff-warnings-count').textContent = staffWithWarnings;
            
            // Recent activity
            const recentActivity = document.getElementById('recent-activity');
            const recentRecords = records.slice(0, 5);
            
            if (recentRecords.length === 0) {
                recentActivity.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No recent activity</p>';
            } else {
                recentActivity.innerHTML = recentRecords.map(record => `
                    <div class="timeline-item">
                        <div class="timeline-date">${formatDate(record.date)}</div>
                        <div class="timeline-category category-${record.category}">${getCategoryName(record.category)}</div>
                        <div class="timeline-content">
                            <strong>${record.staffMember}</strong> - ${record.location}<br>
                            ${record.description.substring(0, 100)}${record.description.length > 100 ? '...' : ''}
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="editRecord('${record.id}')" style="background: linear-gradient(45deg, #17a2b8, #138496); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(45deg, #138496, #117a8b)'" onmouseout="this.style.background='linear-gradient(45deg, #17a2b8, #138496)'">
                                ✏️ Edit
                            </button>
                            <button onclick="deleteRecord('${record.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                🗑️ Delete
                            </button>
                        </div>
                        ${record.photos.length > 0 ? `<div class="timeline-photos">${record.photos.map(photo => {
                            if (photo.isRaw) {
                                return `<div class="timeline-photo" style="background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; text-align: center; cursor: pointer;" onclick="openModal('${photo.data}', '${photo.name}')" title="${photo.name}">
                                    RAW<br>${photo.name.split('.').pop().toUpperCase()}
                                </div>`;
                            } else {
                                return `<img src="${photo.data}" class="timeline-photo" onclick="openModal('${photo.data}')" title="${photo.name}">`;
                            }
                        }).join('')}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // Timeline updates
        function updateTimeline() {
            const container = document.getElementById('timeline-container');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No records found. Start by adding your first compliance record.</p>';
                return;
            }
            
            container.innerHTML = records.map(record => `
                <div class="timeline-item" data-record-id="${record.id}">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="flex: 1;">
                            <div class="timeline-date">${formatDate(record.date)}</div>
                            <div class="timeline-category category-${record.category}">${getCategoryName(record.category)}</div>
                            <div style="display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; margin-left: 10px; background: ${getPriorityColor(record.priority)}20; color: ${getPriorityColor(record.priority)};">
                                ${record.priority.toUpperCase()}
                            </div>
                            <div class="timeline-content" style="margin-top: 15px;">
                                <strong>Staff:</strong> ${record.staffMember}<br>
                                <strong>Location:</strong> ${record.location}<br><br>
                                <strong>Details:</strong><br>
                                ${record.description}
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="editRecord('${record.id}')" style="background: linear-gradient(45deg, #17a2b8, #138496); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(45deg, #138496, #117a8b)'" onmouseout="this.style.background='linear-gradient(45deg, #17a2b8, #138496)'">
                                    ✏️ Edit Record
                                </button>
                                <button onclick="deleteRecord('${record.id}')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                    🗑️ Delete Record
                                </button>
                            </div>
                            ${record.photos.length > 0 ? `
                                <div class="timeline-photos">
                                    ${record.photos.map(photo => {
                                        if (photo.isRaw) {
                                            return `<div class="timeline-photo" style="background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; text-align: center; cursor: pointer;" onclick="openModal('${photo.data}', '${photo.name}')" title="${photo.name}">
                                                RAW<br>${photo.name.split('.').pop().toUpperCase()}
                                            </div>`;
                                        } else {
                                            return `<img src="${photo.data}" class="timeline-photo" onclick="openModal('${photo.data}')" title="${photo.name}">`;
                                        }
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="mass-delete-checkbox" style="display: none;">
                            <input type="checkbox" id="select-${record.id}" onchange="updateMassDeleteButton()" style="transform: scale(1.5);">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const timelineItems = document.querySelectorAll('.timeline-item');
                
                timelineItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(query)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Modal functionality
        function openModal(imageSrc, fileName = '') {
            const modal = document.getElementById('photo-modal');
            
            if (fileName.toLowerCase().endsWith('.dng')) {
                // For DNG files, show a placeholder since browsers can't display them
                modal.innerHTML = `
                    <div class="modal-content" style="background: white; padding: 40px; text-align: center; max-width: 500px;">
                        <div style="font-size: 4rem; margin-bottom: 20px; color: #667eea;">RAW</div>
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Raw Image File</h3>
                        <p style="color: #666; margin-bottom: 20px;">${fileName}</p>
                        <p style="color: #666; font-size: 0.9rem;">This is a DNG (Digital Negative) raw image file. Raw files contain unprocessed image data and cannot be displayed directly in the browser.</p>
                        <button onclick="closeModal()" class="btn" style="margin-top: 20px;">Close</button>
                    </div>
                `;
            } else {
                // For regular images, show the image
                modal.innerHTML = `
                    <div class="modal-content">
                        <img id="modal-image" src="${imageSrc}" alt="Full size photo">
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('photo-modal');
            modal.style.display = 'none';
            // Restore original modal structure
            modal.innerHTML = `
                <div class="modal-content">
                    <img id="modal-image" src="" alt="Full size photo">
                </div>
            `;
        }

        // Export functionality
        function exportData() {
            if (!currentUser) {
                alert('Please sign in to export data');
                return;
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                userEmail: currentUser.email,
                totalRecords: records.length,
                records: records.map(record => ({
                    ...record,
                    photos: record.photos.map(photo => ({ name: photo.name, size: photo.data.length }))
                }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `safety-records-${currentUser.email}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Delete record functionality
        function deleteRecord(recordId) {
            console.log('Attempting to delete record:', recordId);
            const record = records.find(r => r.id === recordId);
            if (!record) {
                console.log('Record not found:', recordId);
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete this record?\n\nStaff: ${record.staffMember}\nLocation: ${record.location}\nDate: ${formatDate(record.date)}\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                // Delete from Firebase
                if (currentUser && isFirebaseInitialized) {
                    console.log('Deleting from Firebase:', recordId);
                    db.collection('users').doc(currentUser.uid).collection('safetyRecords').doc(recordId)
                        .delete()
                        .then(() => {
                            console.log('Successfully deleted from Firebase');
                            // Remove from local records
                            records = records.filter(r => r.id !== recordId);
                            
                            // Note: Staff warnings are NOT decremented when records are deleted
                            // This maintains accountability and pattern tracking
                            
                            // Update displays
                            updateDashboard();
                            updateTimeline();
                            
                            // Show success message
                            alert('Record deleted successfully!');
                        })
                        .catch((error) => {
                            console.error('Error deleting from Firebase:', error);
                            alert('Failed to delete record. Please try again.');
                        });
                } else {
                    console.log('Deleting locally only');
                    // Fallback for non-authenticated users
                    records = records.filter(r => r.id !== recordId);
                    updateDashboard();
                    updateTimeline();
                    alert('Record deleted successfully!');
                }
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getCategoryIcon(category) {
            const icons = {
                'food-safety': '🍽️',
                'health-safety': '⚕️',
                'cleaning': '🧽',
                'training': '📚',
                'equipment': '🔧'
            };
            return icons[category] || '📋';
        }

        function getCategoryName(category) {
            const names = {
                'food-safety': 'Food Safety',
                'health-safety': 'Health & Safety',
                'cleaning': 'Cleaning Standards',
                'training': 'Training Required',
                'equipment': 'Equipment Issue'
            };
            return names[category] || category;
        }

        function getPriorityIcon(priority) {
            const icons = {
                'low': '🟢',
                'medium': '🟡',
                'high': '🔴'
            };
            return icons[priority] || '⚪';
        }

        function getPriorityColor(priority) {
            const colors = {
                'low': '#28a745',
                'medium': '#ffc107',
                'high': '#dc3545'
            };
            return colors[priority] || '#6c757d';
        }

        // Edit Record Functions
        function editRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) {
                alert('❌ Record not found');
                return;
            }

            editingRecordId = recordId;
            
            // Populate the edit form
            document.getElementById('edit-category').value = record.category;
            document.getElementById('edit-priority').value = record.priority;
            document.getElementById('edit-location').value = record.location;
            document.getElementById('edit-description').value = record.description;
            
            // Handle staff members
            editSelectedStaffMembers = [];
            if (record.staffMember) {
                const staffNames = record.staffMember.split(',').map(name => name.trim());
                staffNames.forEach(name => {
                    const staffMember = staffMembers.find(staff => staff.name.toLowerCase() === name.toLowerCase());
                    if (staffMember) {
                        editSelectedStaffMembers.push(staffMember);
                    } else {
                        // Create a temporary staff member for names not in the list
                        editSelectedStaffMembers.push({
                            id: `temp-${Date.now()}-${Math.random()}`,
                            name: name,
                            isTemporary: true
                        });
                    }
                });
            }
            updateEditSelectedStaffTags();
            updateEditHiddenInput();
            
            // Handle photos
            editPhotos = [...record.photos];
            updateEditPhotoPreview();
            
            // Setup edit form handlers
            setupEditFormHandlers();
            
            // Switch to edit section
            showSection('edit-record');
        }

        function setupEditFormHandlers() {
            // Setup edit staff selector
            const input = document.getElementById('edit-staff-member-input');
            const dropdown = document.getElementById('edit-staff-dropdown');
            
            if (!input || !dropdown) return;
            
            // Clear any existing event listeners
            input.removeEventListener('input', handleEditStaffInput);
            input.removeEventListener('focus', showEditStaffDropdown);
            input.removeEventListener('blur', hideEditStaffDropdown);
            
            // Add event listeners
            input.addEventListener('input', handleEditStaffInput);
            input.addEventListener('focus', showEditStaffDropdown);
            input.addEventListener('blur', hideEditStaffDropdown);
            
            // Setup edit photo upload
            setupEditPhotoUpload();
            
            // Setup edit form submission
            setupEditFormSubmission();
        }

        function handleEditStaffInput() {
            const input = document.getElementById('edit-staff-member-input');
            const query = input.value.toLowerCase();
            
            updateEditStaffDropdown(query);
        }

        function showEditStaffDropdown() {
            const dropdown = document.getElementById('edit-staff-dropdown');
            if (dropdown && staffMembers.length > 0) {
                dropdown.style.display = 'block';
                updateEditStaffDropdown();
            }
        }

        function hideEditStaffDropdown() {
            setTimeout(() => {
                const dropdown = document.getElementById('edit-staff-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 200);
        }

        function updateEditStaffDropdown(query = '') {
            const dropdown = document.getElementById('edit-staff-dropdown');
            if (!dropdown) return;
            
            const filteredStaff = staffMembers.filter(staff => 
                staff.name.toLowerCase().includes(query.toLowerCase()) &&
                !editSelectedStaffMembers.some(selected => selected.id === staff.id)
            );
            
            if (filteredStaff.length === 0) {
                dropdown.innerHTML = '<div class="staff-dropdown-item">No staff members found</div>';
                return;
            }
            
            dropdown.innerHTML = filteredStaff.map(staff => `
                <div class="staff-dropdown-item" onclick="selectEditStaffMember('${staff.id}')">
                    ${staff.name}
                </div>
            `).join('');
        }

        function selectEditStaffMember(staffId) {
            const staffMember = staffMembers.find(staff => staff.id === staffId);
            if (!staffMember) return;
            
            if (!editSelectedStaffMembers.some(staff => staff.id === staffId)) {
                editSelectedStaffMembers.push(staffMember);
                updateEditSelectedStaffTags();
                updateEditHiddenInput();
            }
            
            const input = document.getElementById('edit-staff-member-input');
            if (input) {
                input.value = '';
            }
            hideEditStaffDropdown();
        }

        function removeEditSelectedStaff(staffId) {
            editSelectedStaffMembers = editSelectedStaffMembers.filter(staff => staff.id !== staffId);
            updateEditSelectedStaffTags();
            updateEditHiddenInput();
        }

        function updateEditSelectedStaffTags() {
            const container = document.getElementById('edit-selected-staff-tags');
            if (!container) return;
            
            if (editSelectedStaffMembers.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = editSelectedStaffMembers.map(staff => `
                <div class="staff-tag">
                    <span>${staff.name}</span>
                    <button class="staff-tag-remove" onclick="removeEditSelectedStaff('${staff.id}')">×</button>
                </div>
            `).join('');
        }

        function updateEditHiddenInput() {
            const hiddenInput = document.getElementById('edit-staff-member');
            if (hiddenInput) {
                const staffNames = editSelectedStaffMembers.map(staff => staff.name).join(', ');
                hiddenInput.value = staffNames;
            }
        }

        function setupEditPhotoUpload() {
            const photoUpload = document.querySelector('#edit-record .photo-upload');
            const photoInput = document.getElementById('edit-photo-input');
            
            if (!photoUpload || !photoInput) return;
            
            // Drag and drop
            photoUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                photoUpload.classList.add('dragover');
            });
            
            photoUpload.addEventListener('dragleave', () => {
                photoUpload.classList.remove('dragover');
            });
            
            photoUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                photoUpload.classList.remove('dragover');
                handleEditFiles(e.dataTransfer.files);
            });
            
            photoInput.addEventListener('change', (e) => {
                handleEditFiles(e.target.files);
            });
        }

        function handleEditFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.dng')) {
                    if (file.name.toLowerCase().endsWith('.dng')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            editPhotos.push({
                                name: file.name,
                                data: e.target.result,
                                type: file.type || 'application/octet-stream',
                                isRaw: true,
                                processing: false
                            });
                            updateEditPhotoPreview();
                        };
                        reader.readAsDataURL(file);
                    } else {
                        compressEditImage(file);
                    }
                } else {
                    alert(`❌ Unsupported file type: ${file.name}. Please upload JPG, PNG, WebP, or DNG files.`);
                }
            });
        }

        function compressEditImage(file) {
            const placeholderIndex = editPhotos.length;
            editPhotos.push({
                name: file.name,
                data: '',
                type: 'image/jpeg',
                isRaw: false,
                processing: true
            });
            updateEditPhotoPreview();
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                let { width, height } = img;
                const maxSize = 1200;
                
                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                
                editPhotos[placeholderIndex] = {
                    name: file.name.replace(/\.[^/.]+$/, '.jpg'),
                    data: compressedDataUrl,
                    type: 'image/jpeg',
                    isRaw: false,
                    originalSize: file.size,
                    compressedSize: compressedDataUrl.length,
                    processing: false
                };
                
                updateEditPhotoPreview();
            };
            
            img.onerror = function() {
                editPhotos.splice(placeholderIndex, 1);
                updateEditPhotoPreview();
                alert(`❌ Failed to process image: ${file.name}`);
            };
            
            img.src = URL.createObjectURL(file);
        }

        function updateEditPhotoPreview() {
            const preview = document.getElementById('edit-photo-preview');
            if (!preview) return;
            
            preview.innerHTML = editPhotos.map((photo, index) => {
                if (photo.processing) {
                    return `
                        <div style="position: relative;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(45deg, #ffc107, #ff9800); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                                ⏳<br>Processing
                            </div>
                            <button type="button" onclick="removeEditPhoto(${index})" style="position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `;
                } else if (photo.isRaw) {
                    return `
                        <div style="position: relative;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(45deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                                📷 RAW<br>${photo.name.split('.').pop().toUpperCase()}
                            </div>
                            <button type="button" onclick="removeEditPhoto(${index})" style="position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `;
                } else {
                    const sizeInfo = photo.originalSize ? 
                        `<div style="position: absolute; bottom: 2px; left: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px;">
                            ${(photo.data.length / 1024 / 1024).toFixed(1)}MB
                        </div>` : '';
                    
                    return `
                        <div style="position: relative;">
                            <img src="${photo.data}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            ${sizeInfo}
                            <button type="button" onclick="removeEditPhoto(${index})" style="position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removeEditPhoto(index) {
            editPhotos.splice(index, 1);
            updateEditPhotoPreview();
        }

        function setupEditFormSubmission() {
            const form = document.getElementById('edit-record-form');
            if (!form) return;
            
            // Remove existing listener
            form.removeEventListener('submit', handleEditFormSubmit);
            
            // Add new listener
            form.addEventListener('submit', handleEditFormSubmit);
        }

        async function handleEditFormSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('❌ Please sign in to update records');
                return;
            }
            
            if (!editingRecordId) {
                alert('❌ No record selected for editing');
                return;
            }
            
            // Check if photos are still being processed
            const processingPhotos = editPhotos.filter(photo => photo.processing);
            if (processingPhotos.length > 0) {
                alert('⏳ Please wait for photos to finish processing before saving.');
                return;
            }
            
            const originalRecord = records.find(r => r.id === editingRecordId);
            if (!originalRecord) {
                alert('❌ Original record not found');
                return;
            }
            
            // Get the original staff member to handle staff warning updates
            const originalStaffMember = originalRecord.staffMember;
            const newStaffMember = document.getElementById('edit-staff-member').value;
            
            // Create updated record
            const updatedRecord = {
                ...originalRecord,
                category: document.getElementById('edit-category').value,
                priority: document.getElementById('edit-priority').value,
                staffMember: newStaffMember,
                location: document.getElementById('edit-location').value,
                description: document.getElementById('edit-description').value,
                photos: [...editPhotos],
                lastModified: new Date().toISOString()
            };
            
            try {
                // Update in Firebase
                await db.collection('users').doc(currentUser.uid).collection('safetyRecords').doc(editingRecordId).update(updatedRecord);
                
                // Update local record
                const recordIndex = records.findIndex(r => r.id === editingRecordId);
                if (recordIndex !== -1) {
                    records[recordIndex] = updatedRecord;
                }
                
                // Handle staff warning updates if staff member changed
                if (originalStaffMember !== newStaffMember) {
                    // Decrement count for original staff member(s)
                    if (originalStaffMember) {
                        const originalStaffNames = originalStaffMember.split(',').map(name => name.trim());
                        originalStaffNames.forEach(name => {
                            const normalizedName = name.toLowerCase();
                            if (staffWarnings[normalizedName] && staffWarnings[normalizedName].count > 0) {
                                staffWarnings[normalizedName].count--;
                                staffWarnings[normalizedName].warningLevel = getWarningLevel(staffWarnings[normalizedName].count);
                                saveStaffWarningToFirebase(normalizedName);
                            }
                        });
                    }
                    
                    // Increment count for new staff member(s)
                    if (newStaffMember) {
                        updateStaffWarning(newStaffMember);
                    }
                }
                
                // Update displays
                updateDashboard();
                updateTimeline();
                updateStaffWarnings();
                
                // Reset edit form
                resetEditForm();
                
                // Switch to timeline to show the updated record
                showSection('timeline');
                
                alert('✅ Record updated successfully!');
                
            } catch (error) {
                console.error('Error updating record:', error);
                alert('❌ Failed to update record. Please try again.');
            }
        }

        function cancelEdit() {
            resetEditForm();
            showSection('timeline');
        }

        function resetEditForm() {
            // Reset form fields
            document.getElementById('edit-record-form').reset();
            
            // Clear photos and staff selection
            editPhotos = [];
            editSelectedStaffMembers = [];
            editingRecordId = null;
            
            // Update UI
            updateEditPhotoPreview();
            updateEditSelectedStaffTags();
            updateEditHiddenInput();
            
            // Clear input fields
            const input = document.getElementById('edit-staff-member-input');
            if (input) {
                input.value = '';
            }
        }
    </script>
</body>
</html>